var w=(o,n)=>()=>(n||o((n={exports:{}}).exports,n),n.exports);var $=w((Y,T)=>{var y=require("@serverless-devs/core"),{lodash:r}=y,N={PATH:":/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin",LAYERS:{nodejs17:{layer:"node-v17.8.0-linux-x64",path:"/opt/node-v17.8.0-linux-x64/bin"},nodejs16:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},nodejs14:{layer:"node-v14.19.1-linux-x64",path:"/opt/node-v14.19.1-linux-x64/bin"},nodejs12:{layer:"node-v12.22.11-linux-x64",path:"/opt/node-v12.22.11-linux-x64/bin"},"python3.10":{layer:"python-v3.10-linux-x64",path:"/opt/python-v3.10-linux-x64/bin"},"python3.9":{layer:"python-v3.9-linux-x64",path:"/opt/python-v3.9-linux-x64/bin"},"python3.8":{layer:"python-v3.8-linux-x64",path:"/opt/python-v3.8-linux-x64/bin"},"python3.6":{layer:"python-v3.6-linux-x64",path:"/opt/python-v3.6-linux-x64/bin"},"php8.1":{layer:"php-v8.1-linux-x64",path:"/opt/php-v8.1-linux-x64/bin"},"php8.0":{layer:"php-v8.0-linux-x64",path:"/opt/php-v8.0-linux-x64/bin"},"php7.2":{layer:"php-v7.2-linux-x64",path:"/opt/php-v7.2-linux-x64/bin"},"php5.6":{layer:"php-v5.6-linux-x64",path:"/opt/php-v5.6-linux-x64/bin"},java17:{layer:"java-v17.0.2-linux-x64",path:"/opt/java-v17.0.2-linux-x64/bin"},java11:{layer:"java-v11.0.14-linux-x64",path:"/opt/java-v11.0.14-linux-x64/bin"},typescript:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},dotnet6:{layer:"dotnet6",path:"/opt/dotnet6"}}},S=(o,n)=>{if(!n)throw new y.CatchableError("layer-fc args must exist!");if(n.name){if(!(n.codeUri||n.ossBucket))throw new y.CatchableError("Missing args: codeUri or ossBucket");r.isEmpty(n.runtime)||r.includes(n.runtime,r.get(o,"props.function.runtime"))||(n.runtime=r.concat(n.runtime,r.get(o,"props.function.runtime")))}else if(n.customRuntime&&r.get(o,"props.function.runtime")!=="custom")throw new y.CatchableError(`props.function.runtime: "${r.get(o,"props.function.runtime")}" is not correct, Should be "custom"`)};T.exports={SYSTERMPATH:N,checkArgs:S}});var U=require("@serverless-devs/core"),{lodash:e,loadComponent:k,Logger:C}=U,j=new C("layer-fc"),{SYSTERMPATH:O,checkArgs:D}=$(),{PATH:F,LAYERS:E}=O;module.exports=async function(n,i){D(n,i),j.debug(`inputs params: ${JSON.stringify(n)}`),j.debug(`args params: ${JSON.stringify(i)}`);let{codeUri:H=null,description:R=null,customRuntime:s=null}=i,{ossBucket:m=null,ossKey:v=null,name:f=null,runtime:b}=i,_=e.get(n,"props.region","cn-hangzhou"),c={},g={};if(s)if(E[s])c=E[s],m=`fc-layers-${_}`,v=`${e.get(c,"layer")}.zip`,f=`${s}_fc_auto_created`,g={runtime:"custom"},b=["custom"];else return n;let l=e.merge(n,{props:{layerName:f,code:H,compatibleRuntime:b,description:R,ossBucket:m,ossKey:v,function:g}}),a=e.get(n,"props.function.environmentVariables",{NODE_PATH:void 0,PATH:void 0});if(e.isEmpty(c)){let t=a.NODE_PATH,p="/opt/node_modules:/opt/nodejs/node_modules";e.includes(t,p)||(a.NODE_PATH=t?`${p}:${t}`:p)}else{let t=a.PATH||"",p=`${c.path}${F}`;e.includes(t,p)||(a.PATH=t?`${p}:${t}`:p)}let A=await k("devsapp/fc-layer"),x,d=await A.list({args:`--region ${n.props.region} --prefix ${i.name}`,credentials:n.credentials,project:n.project});i.forceUpdate||e.isEmpty(d)||e.size(e.filter(d,t=>t.layerName===i.name))===0?x=await A.publish(l):x=e.get(d,"[0].arn");let h=e.get(l,"props.layersFcInputsUni"),u=e.get(l,"props.function.layers",[]);e.isNil(h)&&(l.props.layersFcInputsUni=u,h=u);let P=e.dropRight(u,h.length);return x&&(P.push(x),u=e.concat(P,h)),l=e.merge(l,{props:{function:{environmentVariables:a,layers:u}}}),l};
