var _=(i,n)=>()=>(n||i((n={exports:{}}).exports,n),n.exports);var E=_((F,j)=>{var y=require("@serverless-devs/core"),{lodash:l}=y,$={PATH:":/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin",DEFAULT_EXAMPLE:{layer:"custom-default-code",code:"default-web-code"},LAYERS:{nodejs17:{layer:"node-v17.8.0-linux-x64",path:"/opt/node-v17.8.0-linux-x64/bin"},nodejs16:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},nodejs14:{layer:"node-v14.19.1-linux-x64",path:"/opt/node-v14.19.1-linux-x64/bin"},nodejs12:{layer:"node-v12.22.11-linux-x64",path:"/opt/node-v12.22.11-linux-x64/bin"},"python3.10":{layer:"python-v3.10-linux-x64",path:"/opt/python-v3.10-linux-x64/bin"},"python3.9":{layer:"python-v3.9-linux-x64",path:"/opt/python-v3.9-linux-x64/bin"},"python3.8":{layer:"python-v3.8-linux-x64",path:"/opt/python-v3.8-linux-x64/bin"},"python3.6":{layer:"python-v3.6-linux-x64",path:"/opt/python-v3.6-linux-x64/bin"},"php8.1":{layer:"php-v8.1-linux-x64",path:"/opt/php-v8.1-linux-x64/bin"},"php8.0":{layer:"php-v8.0-linux-x64",path:"/opt/php-v8.0-linux-x64/bin"},"php7.2":{layer:"php-v7.2-linux-x64",path:"/opt/php-v7.2-linux-x64/bin"},"php5.6":{layer:"php-v5.6-linux-x64",path:"/opt/php-v5.6-linux-x64/bin"},java17:{layer:"java-v17.0.2-linux-x64",path:"/opt/java-v17.0.2-linux-x64/bin"},java11:{layer:"java-v11.0.14-linux-x64",path:"/opt/java-v11.0.14-linux-x64/bin"},typescript:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"}},NODEJS:["nodejs17","nodejs16","nodejs14","nodejs12","nodejs10"],PYTHON:["python3.10","python3.9","python3.8","python3.7","python3.6"],JAVA:["java17","java11","java8"],PHP:["php8.1","php8.0","php7.4","php7.2","php5.6"],GO:["go1"],OTHERS:["typescript","rust","ruby","dart","lua"]},w=(i,n)=>{if(!n)throw new y.CatchableError("layer-fc args must exist!");if(n.name){if(!(n.codeUri||n.ossBucket))throw new y.CatchableError("Missing args: codeUri or ossBucket");l.isEmpty(n.runtime)||l.includes(n.runtime,l.get(i,"props.function.runtime"))||(n.runtime=l.concat(n.runtime,l.get(i,"props.function.runtime")))}else if(n.customRuntime&&l.get(i,"props.function.runtime")!=="custom")throw new y.CatchableError(`props.function.runtime: "${l.get(i,"props.function.runtime")}" is not correct, Should be "custom"`)};j.exports={SYSTERMPATH:$,checkArgs:w}});var S=require("@serverless-devs/core"),{lodash:e,loadComponent:O,Logger:U}=S,T=new U("layer-fc"),{SYSTERMPATH:D,checkArgs:L}=E(),{PATH:k,LAYERS:H}=D;module.exports=async function(n,r){L(n,r),T.debug(`inputs params: ${JSON.stringify(n)}`),T.debug(`args params: ${JSON.stringify(r)}`);let{codeUri:N=null,description:R=null,customRuntime:s=null}=r,{ossBucket:m=null,ossKey:v=null,name:f=null,runtime:b}=r,c={},g={};if(s)if(H[s])c=H[s],m=`fc-layers-${e.get(n,"props.region","cn-hangzhou")}`,v=`${e.get(c,"layer")}.zip`,f=`${s}_fc_auto_created`,g={runtime:"custom"},b=["custom"];else return n;let o=e.merge(n,{props:{layerName:f,code:N,compatibleRuntime:b,description:R,ossBucket:m,ossKey:v,function:g}}),a=e.get(n,"props.function.environmentVariables",{NODE_PATH:void 0,PATH:void 0});if(e.isEmpty(c)){let t=a.NODE_PATH,p="/opt/node_modules:/opt/nodejs/node_modules";e.includes(t,p)||(a.NODE_PATH=t?`${p}:${t}`:p)}else{let t=a.PATH||"",p=`${c.path}${k}`;e.includes(t,p)||(a.PATH=t?`${p}:${t}`:p)}let A=await O("devsapp/fc-layer"),h,d=await A.list(o);r.forceUpdate||e.isEmpty(d)||e.size(e.filter(d,t=>t.layerName===r.name))===0?h=await A.publish(o):h=e.get(e.maxBy(d,t=>t.version),"arn");let x=e.get(o,"props.layersFcInputsUni"),u=e.get(o,"props.function.layers",[]);e.isNil(x)&&(o.props.layersFcInputsUni=u,x=u);let P=e.dropRight(u,x.length);return h&&(P.push(h),u=e.concat(P,x)),o=e.merge(o,{props:{function:{environmentVariables:a,layers:u}}}),o};
