var _=(o,n)=>()=>(n||o((n={exports:{}}).exports,n),n.exports);var E=_((Y,P)=>{var y=require("@serverless-devs/core"),{lodash:r}=y,w={PATH:":/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin",DEFAULT_EXAMPLE:{layer:"custom-default-code",code:"default-web-code"},LAYERS:{nodejs17:{layer:"node-v17.8.0-linux-x64",path:"/opt/node-v17.8.0-linux-x64/bin"},nodejs16:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},nodejs14:{layer:"node-v14.19.1-linux-x64",path:"/opt/node-v14.19.1-linux-x64/bin"},nodejs12:{layer:"node-v12.22.11-linux-x64",path:"/opt/node-v12.22.11-linux-x64/bin"},"python3.10":{layer:"python-v3.10-linux-x64",path:"/opt/python-v3.10-linux-x64/bin"},"python3.9":{layer:"python-v3.9-linux-x64",path:"/opt/python-v3.9-linux-x64/bin"},"python3.8":{layer:"python-v3.8-linux-x64",path:"/opt/python-v3.8-linux-x64/bin"},"python3.6":{layer:"python-v3.6-linux-x64",path:"/opt/python-v3.6-linux-x64/bin"},"php8.1":{layer:"php-v8.1-linux-x64",path:"/opt/php-v8.1-linux-x64/bin"},"php8.0":{layer:"php-v8.0-linux-x64",path:"/opt/php-v8.0-linux-x64/bin"},"php7.2":{layer:"php-v7.2-linux-x64",path:"/opt/php-v7.2-linux-x64/bin"},"php5.6":{layer:"php-v5.6-linux-x64",path:"/opt/php-v5.6-linux-x64/bin"},java17:{layer:"java-v17.0.2-linux-x64",path:"/opt/java-v17.0.2-linux-x64/bin"},java11:{layer:"java-v11.0.14-linux-x64",path:"/opt/java-v11.0.14-linux-x64/bin"},typescript:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"}},NODEJS:["nodejs17","nodejs16","nodejs14","nodejs12","nodejs10"],PYTHON:["python3.10","python3.9","python3.8","python3.7","python3.6"],JAVA:["java17","java11","java8"],PHP:["php8.1","php8.0","php7.4","php7.2","php5.6"],GO:["go1"],OTHERS:["typescript","rust","ruby","dart","lua"]},S=(o,n)=>{if(!n)throw new y.CatchableError("layer-fc args must exist!");if(n.name){if(!(n.codeUri||n.ossBucket))throw new y.CatchableError("Missing args: codeUri or ossBucket");r.isEmpty(n.runtime)||r.includes(n.runtime,r.get(o,"props.function.runtime"))||(n.runtime=r.concat(n.runtime,r.get(o,"props.function.runtime")))}else if(n.customRuntime&&r.get(o,"props.function.runtime")!=="custom")throw new y.CatchableError(`props.function.runtime: "${r.get(o,"props.function.runtime")}" is not correct, Should be "custom"`)};P.exports={SYSTERMPATH:w,checkArgs:S}});var O=require("@serverless-devs/core"),{lodash:e,loadComponent:U,Logger:D}=O,T=new D("layer-fc"),{SYSTERMPATH:L,checkArgs:k}=E(),{PATH:C,LAYERS:H}=L;module.exports=async function(n,i){k(n,i),T.debug(`inputs params: ${JSON.stringify(n)}`),T.debug(`args params: ${JSON.stringify(i)}`);let{codeUri:$=null,description:N=null,customRuntime:u=null}=i,{ossBucket:m=null,ossKey:v=null,name:f=null,runtime:b}=i,R=e.get(n,"props.region","cn-hangzhou"),c={},g={};if(u)if(H[u])c=H[u],m=`fc-layers-${R}`,v=`${e.get(c,"layer")}.zip`,f=`${u}_fc_auto_created`,g={runtime:"custom"},b=["custom"];else return n;let p=e.merge(n,{props:{layerName:f,code:$,compatibleRuntime:b,description:N,ossBucket:m,ossKey:v,function:g}}),a=e.get(n,"props.function.environmentVariables",{NODE_PATH:void 0,PATH:void 0});if(e.isEmpty(c)){let t=a.NODE_PATH,l="/opt/node_modules:/opt/nodejs/node_modules";e.includes(t,l)||(a.NODE_PATH=t?`${l}:${t}`:l)}else{let t=a.PATH||"",l=`${c.path}${C}`;e.includes(t,l)||(a.PATH=t?`${l}:${t}`:l)}let j=await U("devsapp/fc-layer"),h,d=await j.list({args:`--region ${n.props.region} --prefix ${i.name}`,credentials:n.credentials,project:n.project});i.forceUpdate||e.isEmpty(d)||e.size(e.filter(d,t=>t.layerName===i.name))===0?h=await j.publish(p):h=e.get(d,"[0].arn");let x=e.get(p,"props.layersFcInputsUni"),s=e.get(p,"props.function.layers",[]);e.isNil(x)&&(p.props.layersFcInputsUni=s,x=s);let A=e.dropRight(s,x.length);return h&&(A.push(h),s=e.concat(A,x)),p=e.merge(p,{props:{function:{environmentVariables:a,layers:s}}}),p};
